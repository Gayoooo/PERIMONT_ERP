#!/usr/bin/env python3
"""
Script de test_protocols pour PERIMONT_ERP
Module: venv.Lib.site-packages.numpy._core.tests.test_protocols.py
Auteur: PERIMONT S.A.S
Date: 2025-12-29
"""
import warnings

import pytest

import numpy as np


@pytest.mark.filterwarnings("error")
def test_getattr_warning():
    # issue gh-14735: make sure we clear only getattr errors, and let warnings
    # through
    class Wrapper:
        def __init__(self, array):
            self.array = array

        def __len__(self):
            return len(self.array)

        def __getitem__(self, item):
            return type(self)(self.array[item])

        def __getattr__(self, name):
            if name.startswith("__array_"):
                warnings.warn("object got converted", UserWarning, stacklevel=1)

            return getattr(self.array, name)

        def __repr__(self):
            return f"<Wrapper({self.array})>"

    array = Wrapper(np.arange(10))
    with pytest.raises(UserWarning, match="object got converted"):
        np.asarray(array)


def test_array_called():
    class Wrapper:
        val = '0' * 100

        def __array__(self, dtype=None, copy=None):
            return np.array([self.val], dtype=dtype, copy=copy)

    wrapped = Wrapper()
    arr = np.array(wrapped, dtype=str)
    assert arr.dtype == 'U100'
    assert arr[0] == Wrapper.val

